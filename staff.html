<!DOCTYPE html>
<html>
<head>
  <title>Staff Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    button { padding: 15px; font-size: 20px; background: green; color: white; border: none; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Staff Control Panel</h2>
  <div id="currentToken">Current Token: #---</div>
  <button onclick="nextToken()">Next</button>
  <audio id="audioPlayer" controls hidden></audio>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      databaseURL: "https://smart-hospital-51bf4-default-rtdb.firebaseio.com/"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let queue = [];

    db.ref("token").on("value", (snapshot) => {
      const data = snapshot.val() || {};
      queue = Object.entries(data)
        .filter(([k, v]) => k !== "current" && v.status === "waiting")
        .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));

      const current = data.current || "---";
      document.getElementById("currentToken").innerText = `Current Token: #${current}`;
    });

    function nextToken() {
      if (queue.length === 0) return alert("No patients in queue");

      const [nextToken, info] = queue.shift();
      db.ref("token/current").set(nextToken);
      db.ref("token/" + nextToken + "/status").set("called");

      const audio = document.getElementById("audioPlayer");
      audio.src = `/sounds/token_${nextToken}.mp3`;
      audio.play();
    }
  </script>
</body>
</html>
