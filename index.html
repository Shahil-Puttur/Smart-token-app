<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Patient Token</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>üéüÔ∏è Take Your Token / ‡≤ü‡≥ã‡≤ï‡≤®‡≥ç ‡≤™‡≤°‡≥Ü‡≤Ø‡≤ø‡≤∞‡≤ø</h1>

    <div id="form">
      <input id="name" placeholder="Your Name / ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å" />
      <input id="phone" placeholder="Phone Number / ‡≤´‡≥ã‡≤®‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç" />
      <button id="submitBtn">Done (‡≤Æ‡≥Å‡≤ó‡≤ø‡≤Ø‡≤ø‡≤§‡≥Å)</button>
    </div>

    <div id="user-token" style="display:none;">
      <h2 id="myTokenDisplay">Your Token: -</h2>
      <h2 id="currentTokenDisplay">Current Token: -</h2>
      <p>üëâ Sit and wait. / ‡≤ï‡≥Å‡≤≥‡≤ø‡≤§‡≥Å‡≤ï‡≥ä‡≤≥‡≥ç‡≤≥‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤ï‡≤æ‡≤Ø‡≤ø‡≤∞‡≤ø.</p>
    </div>
  </div>

  <!-- Audio players -->
  <audio id="welcomeAudio" src="sounds/welcome.mp3"></audio>
  <audio id="alarmAudio"   src="sounds/alarm.mp3"></audio>
  <audio id="skippedAudio" src="sounds/skipped.mp3"></audio>

  <!-- Firebase + app logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, push, onValue, get, child
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // your firebase-config.js could export these; inline here for simplicity
    const firebaseConfig = {
      apiKey: "AIzaSyAfTE0aLnioPS1vKEMq96m5vxO9iqaxBYk",
      authDomain: "smart-hospital-51bf4.firebaseapp.com",
      databaseURL: "https://smart-hospital-51bf4-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smart-hospital-51bf4",
      storageBucket: "smart-hospital-51bf4.appspot.com",
      messagingSenderId: "614166639876",
      appId: "1:614166639876:web:e45d373639ba6edaa38c51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tokenRef = ref(db, 'token');

    // 1. Connectivity test
    async function testFirebase() {
      try {
        const dbRef = ref(db);
        const snap = await get(child(dbRef, 'token/test'));
        if (snap.exists()) {
          alert("‚úÖ Firebase Connected! Test data found.");
        } else {
          alert("‚úÖ Firebase Connected! No test data (that‚Äôs fine).");
        }
      } catch (e) {
        alert("‚ùå Firebase NOT Connected: " + e.message);
      }
    }
    testFirebase();

    // 2. Elements
    const formDiv   = document.getElementById('form');
    const userDiv   = document.getElementById('user-token');
    const nameEl    = document.getElementById('name');
    const phoneEl   = document.getElementById('phone');
    const submitBtn = document.getElementById('submitBtn');
    const myTok     = document.getElementById('myTokenDisplay');
    const curTok    = document.getElementById('currentTokenDisplay');
    const welcomeA  = document.getElementById('welcomeAudio');
    const alarmA    = document.getElementById('alarmAudio');
    const skippedA  = document.getElementById('skippedAudio');

    submitBtn.onclick = () => {
      const name  = nameEl.value.trim();
      const phone = phoneEl.value.trim();
      if (!name || !phone) return alert("Fill both fields!");

      push(tokenRef, { name, phone, status: 'waiting' })
        .then(() => {
          welcomeA.play();
          formDiv.style.display = 'none';
          userDiv.style.display = 'block';
        });
    };

    // 3. Listen for changes
    onValue(tokenRef, snapshot => {
      const all = [];
      snapshot.forEach(c => all.push({ key: c.key, ...c.val() }));
      // current = first status='called'
      const called = all.find(t => t.status==='called');
      curTok.innerText = `Current Token: ${called ? called.phone : '-'}`;
      // my token display
      const me = all.find(t => t.phone===phoneEl.value.trim());
      if (me) {
        myTok.innerText = `Your Token: ${me.phone}`;
        if (me.status==='called') alarmA.play();
        if (me.status==='skipped') {
          skippedA.play();
          myTok.innerText = 'Your token was skipped.';
        }
      }
    });
  </script>
</body>
</html>
